name: Build Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: ShellCheck
        run: |
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh scripts/lib/*.sh

      - name: Build Hugo sites
        run: |
          for site_dir in sites/*/; do
            name=$(basename "$site_dir")
            [ "$name" = "_template" ] && continue
            [ "$name" = "_shared" ] && continue
            [ ! -f "$site_dir/site.yaml" ] && continue

            site_type=$(grep "^type:" "$site_dir/site.yaml" | awk '{print $2}' | tr -d '"')
            if [ "$site_type" = "hugo" ]; then
              echo "Building: $name"
              hugo -s "$site_dir" --gc --minify
            else
              echo "Skipping static site: $name"
            fi
          done

      - name: Verify template builds
        run: |
          hugo -s sites/_template/ --gc --minify

      - name: Check required files
        run: |
          # Verify shared files exist
          test -f sites/_shared/privacy-policy.html
          test -f sites/_shared/about.html
          test -f sites/_shared/adsense-snippet.html
          test -f sites/_shared/analytics-snippet.html
          test -f sites/_shared/ads.txt

          # Verify template structure
          test -f sites/_template/hugo.toml
          test -d sites/_template/layouts
          test -d sites/_template/content
          test -f sites/_template/static/ads.txt

          # Verify scripts exist and are executable
          for script in setup.sh new-site.sh fork-site.sh check-repo.sh \
                        deploy.sh deploy-all.sh build-all.sh dns-setup.sh \
                        generate-dashboard.sh lighthouse-check.sh; do
            test -f "scripts/$script"
          done

          # Verify dashboard template
          test -f dashboard/template.html

          echo "All required files present."

      - name: Validate n8n workflows
        run: |
          for f in n8n/workflows/*.json; do
            [ ! -f "$f" ] && continue
            echo "Validating: $f"
            python3 -c "import json; json.load(open('$f'))"
          done
          echo "All workflows are valid JSON."
