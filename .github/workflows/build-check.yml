name: Build Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Hugo
        env:
          HUGO_VERSION: '0.156.0'
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            curl -sL "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz" -o hugo.tar.gz
            tar -xzf hugo.tar.gz
            sudo mv hugo /usr/local/bin/
            rm hugo.tar.gz
          elif [ "$RUNNER_OS" = "macOS" ]; then
            curl -sL "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_darwin-universal.pkg" -o hugo.pkg
            sudo installer -pkg hugo.pkg -target /
            rm hugo.pkg
          fi
          hugo version

      - name: Install ShellCheck (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get install -y shellcheck

      - name: ShellCheck
        if: runner.os == 'Linux'
        run: shellcheck scripts/*.sh scripts/lib/*.sh

      - name: Build Hugo sites
        run: |
          for site_dir in sites/*/; do
            name=$(basename "$site_dir")
            [ "$name" = "_template" ] && continue
            [ "$name" = "_shared" ] && continue
            [ ! -f "$site_dir/site.yaml" ] && continue

            site_type=$(grep "^type:" "$site_dir/site.yaml" | awk '{print $2}' | tr -d '"')
            if [ "$site_type" = "hugo" ]; then
              echo "Building: $name"
              hugo -s "$site_dir" --gc --minify
            else
              echo "Skipping static site: $name"
            fi
          done

      - name: Verify template builds
        run: |
          hugo -s sites/_template/ --gc --minify

      - name: Check required files
        run: |
          # Verify shared files exist
          test -f sites/_shared/privacy-policy.html
          test -f sites/_shared/about.html
          test -f sites/_shared/adsense-snippet.html
          test -f sites/_shared/analytics-snippet.html
          test -f sites/_shared/ads.txt

          # Verify template structure
          test -f sites/_template/hugo.toml
          test -d sites/_template/layouts
          test -d sites/_template/content
          test -f sites/_template/static/ads.txt

          # Verify scripts exist
          for script in setup.sh new-site.sh fork-site.sh check-repo.sh \
                        deploy.sh deploy-all.sh build-all.sh dns-setup.sh \
                        generate-dashboard.sh lighthouse-check.sh \
                        launch-site.sh generate-content.sh \
                        generate-content-plan.sh generate-seed-content.sh; do
            test -f "scripts/$script"
          done

          # Verify lib scripts exist
          for lib in config.sh logging.sh inject.sh platform.sh llm.sh verify.sh; do
            test -f "scripts/lib/$lib"
          done

          # Verify dashboard template
          test -f dashboard/template.html

          echo "All required files present."

      - name: Validate n8n workflows
        run: |
          for f in n8n/workflows/*.json; do
            [ ! -f "$f" ] && continue
            echo "Validating: $f"
            python3 -c "import json; json.load(open('$f'))"
          done
          echo "All workflows are valid JSON."
