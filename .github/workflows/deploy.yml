name: Deploy Sites

on:
  push:
    branches: [main]
    paths:
      - 'sites/**'
      - 'themes/**'
      - '!sites/_template/**'
      - '!sites/_shared/**'
  workflow_dispatch:
    inputs:
      site_name:
        description: 'Site name to deploy (leave empty for all changed sites)'
        required: false
        type: string
      deploy_all:
        description: 'Deploy ALL sites (for initial setup after fork)'
        required: false
        type: boolean
        default: false

env:
  HUGO_VERSION: '0.156.0'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      sites: ${{ steps.changed.outputs.sites }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - id: changed
        name: Detect changed sites
        run: |
          if [ -n "${{ inputs.site_name }}" ]; then
            echo "sites=[\"${{ inputs.site_name }}\"]" >> "$GITHUB_OUTPUT"
          elif [ "${{ inputs.deploy_all }}" = "true" ]; then
            SITES=$(ls -d sites/*/ 2>/dev/null | while read -r dir; do
              name=$(basename "$dir")
              [ "$name" = "_template" ] && continue
              [ "$name" = "_shared" ] && continue
              [ -f "$dir/site.yaml" ] && echo "$name"
            done | jq -R -c -s 'split("\n") | map(select(length > 0))')
            echo "sites=$SITES" >> "$GITHUB_OUTPUT"
          else
            # Check if theme files changed â€” if so, deploy all Hugo sites
            THEME_CHANGED=$(git diff --name-only HEAD~1 -- 'themes/' | wc -l | tr -d ' ')
            if [ "$THEME_CHANGED" -gt 0 ]; then
              SITES=$(ls -d sites/*/ 2>/dev/null | while read -r dir; do
                name=$(basename "$dir")
                [ "$name" = "_template" ] && continue
                [ "$name" = "_shared" ] && continue
                # Only Hugo sites need rebuild when theme changes
                if [ -f "$dir/hugo.toml" ] || ([ -f "$dir/site.yaml" ] && grep -q "^type: hugo" "$dir/site.yaml" 2>/dev/null); then
                  echo "$name"
                fi
              done | jq -R -c -s 'split("\n") | map(select(length > 0))')
            else
              SITES=$(git diff --name-only HEAD~1 -- 'sites/' | \
                grep -v '_template\|_shared' | \
                cut -d'/' -f2 | sort -u | \
                jq -R -c -s 'split("\n") | map(select(length > 0))')
            fi
            echo "sites=$SITES" >> "$GITHUB_OUTPUT"
          fi

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.sites != '[]' && needs.detect-changes.outputs.sites != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: ${{ fromJSON(needs.detect-changes.outputs.sites) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Setup Hugo
        run: |
          curl -sL "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz" -o hugo.tar.gz
          tar -xzf hugo.tar.gz
          sudo mv hugo /usr/local/bin/
          rm hugo.tar.gz

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create config.yaml
        run: |
          cat > config.yaml << EOF
          domain:
            name: "${{ secrets.SF_DOMAIN }}"
            namesilo_api_key: "${{ secrets.SF_NAMESILO_API_KEY }}"
          vercel:
            token: "${{ secrets.SF_VERCEL_TOKEN }}"
            team_id: "${{ secrets.SF_VERCEL_TEAM_ID }}"
          adsense:
            publisher_id: "${{ secrets.SF_ADSENSE_PUB_ID }}"
            enabled: true
          analytics:
            google_analytics_id: "${{ secrets.SF_GA_ID }}"
            google_search_console_verification: ""
          ai:
            provider: "claude"
            providers:
              claude:
                api_key: ""
                model: "claude-sonnet-4-6"
          monitoring:
            uptimerobot_api_key: ""
          defaults:
            language: "en"
            timezone: "America/New_York"
            author:
              name: "SiteFactory"
              email: ""
          EOF

      - name: Detect root domain flag
        id: root-check
        run: |
          if grep -q "^root_domain: true" "sites/${{ matrix.site }}/site.yaml" 2>/dev/null; then
            echo "flag=--root" >> "$GITHUB_OUTPUT"
          else
            echo "flag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy ${{ matrix.site }}
        run: ./scripts/deploy.sh "${{ matrix.site }}" ${{ steps.root-check.outputs.flag }}

      - name: Setup DNS
        run: ./scripts/dns-setup.sh "${{ matrix.site }}" ${{ steps.root-check.outputs.flag }} || echo "::warning::DNS setup failed for ${{ matrix.site }} - manual verification required"
